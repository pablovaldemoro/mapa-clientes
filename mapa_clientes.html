<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Mapa de Clientes – España</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial; }
    header {
      background:#222; color:#fff; padding:10px 14px;
      display:flex; flex-direction:column; gap:4px;
    }
    header h1 { font-size:18px; margin:0; }
    #status { font-size:13px; color:#ddd; }
    #map { height: calc(100% - 80px); }

    .legend {
      position:absolute; bottom:12px; left:12px; background:#fff; padding:8px 10px;
      border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.3); font-size:12px; z-index:1000;
      max-width:220px;
    }
    .legend-title { font-weight:bold; margin-bottom:4px; display:block; }
    .legend-item { display:flex; align-items:center; margin:2px 0; line-height:1.2; }
    .legend-color { width:12px; height:12px; border-radius:50%; margin-right:6px; flex-shrink:0; }
    #legend-pie-wrapper { margin-top:8px; text-align:center; }
    #legend-pie { width:80px; height:80px; border-radius:50%; margin:4px auto; border:1px solid #ccc; }
    #legend-pie-caption { font-size:11px; color:#555; }
  </style>
</head>
<body>

<header>
  <h1>Mapa de Clientes – España</h1>
  <div id="status">Cargando clientes…</div>
</header>

<div id="map"></div>

<div class="legend">
  <span class="legend-title">Leyenda</span>
  <div id="legend-stats"></div>
  <div id="legend-pie-wrapper">
    <div id="legend-pie"></div>
    <div id="legend-pie-caption"></div>
  </div>
</div>

<script>
// ------------------ CLIENTES (del Word) ------------------
const CLIENTES = [
  {empresa:"Aguardientes de Galicia", municipio:"Vedra", sector:"Food and Beverage"},
  {empresa:"Alcoholera Catalana", municipio:"Santa Margarida i Els Monjos", sector:"Detergence and Chemistry"},
  {empresa:"Alcoholes del Sur", municipio:"Córdoba", sector:"Food and Beverage"},
  {empresa:"Alcoholes Oliva", municipio:"Barcelona", sector:"Food and Beverage"},
  {empresa:"Alcoprodis", municipio:"Aldaia", sector:"Detergence and Chemistry"},
  {empresa:"Antonio Nadal", municipio:"Marratxí", sector:"Food and Beverage"},
  {empresa:"Antonio Puig", municipio:"Barcelona", sector:"Perfume and Cosmetic"},
  {empresa:"Bacardi", municipio:"Mollet del Valles", sector:"Food and Beverage"},
  {empresa:"Bardinet", municipio:"Gélida", sector:"Food and Beverage"},
  {empresa:"Beam Spain", municipio:"Valverde de Majano", sector:"Food and Beverage"},
  {empresa:"Beiesdorf", municipio:"Tres Cantos", sector:"Perfume and Cosmetic"},
  {empresa:"Benito Parraga", municipio:"Murcia", sector:"Nutrition and Pharma"},
  {empresa:"Berioska", municipio:"Cheste", sector:"Perfume and Cosmetic"},
  {empresa:"Berkem", municipio:"Quart de Poblet", sector:"Food and Beverage"},
  {empresa:"Beveland", municipio:"Sant Joan de Les Fonts", sector:"Food and Beverage"},
  {empresa:"Biosearch", municipio:"La Jonquera", sector:"Nutrition and Pharma"},
  {empresa:"Fundador", municipio:"Jerez de la Frontera", sector:"Food and Beverage"},
  {empresa:"Osborne", municipio:"El Puerto de Santa Maria", sector:"Food and Beverage"},
  {empresa:"Sanviver", municipio:"Fuenlabrada", sector:"Food and Beverage"},
  {empresa:"Williams and Humbert", municipio:"Jerez de la Frontera", sector:"Food and Beverage"},
  {empresa:"Cruz Conde", municipio:"Montilla", sector:"Food and Beverage"},
  {empresa:"Briseis", municipio:"Almeria", sector:"Perfume and Cosmetic"},
  {empresa:"Caves da Montanha", municipio:"Anadia", sector:"Food and Beverage"},
  {empresa:"Cogrami Canarias", municipio:"Ingenio", sector:"Food and Beverage"},
  {empresa:"Colep", municipio:"Vale de Cambra", sector:"Perfume and Cosmetic"},
  {empresa:"Coty", municipio:"Granollers", sector:"Perfume and Cosmetic"},
  {empresa:"De Luque", municipio:"Jerez de la Frontera", sector:"Food and Beverage"},
  {empresa:"De Ruy", municipio:"Antequera", sector:"Perfume and Cosmetic"},
  {empresa:"Destilerias Compostela", municipio:"Cotimunde", sector:"Food and Beverage"},
  {empresa:"Destilerias Espronceda", municipio:"Almendralejo", sector:"Food and Beverage"},
  {empresa:"Joaquin Alonso", municipio:"Atarfe", sector:"Food and Beverage"},
  {empresa:"Destilerias La Huertana", municipio:"Alcantarilla", sector:"Food and Beverage"},
  {empresa:"DZ Licores", municipio:"Cartagena", sector:"Food and Beverage"},
  {empresa:"Ecovinal", municipio:"Sartaguda", sector:"Food and Beverage"},
  {empresa:"ESES", municipio:"Zuera", sector:"Detergence and Chemistry"},
  {empresa:"Fernando Ribeiro Abreu", municipio:"Alcanena", sector:"Food and Beverage"},
  {empresa:"Francisco Aragon", municipio:"Molina de Segura", sector:"Perfume and Cosmetic"},
  {empresa:"Gonzalez Byass", municipio:"Jerez de la Frontera", sector:"Food and Beverage"},
  {empresa:"Goyval Vinagres", municipio:"Madrigueras", sector:"Food and Beverage"},
  {empresa:"Hijo de Rafael Reyes", municipio:"Rute", sector:"Food and Beverage"},
  {empresa:"Hugworld International Distribution", municipio:"Toledo", sector:"Perfume and Cosmetic"},
  {empresa:"Iberalcohol", municipio:"Valdemoro", sector:"Detergence and Chemistry"},
  {empresa:"J Carranca Redondo", municipio:"Lousa", sector:"Food and Beverage"},
  {empresa:"Jose Estevez", municipio:"Jerez de la Frontera", sector:"Food and Beverage"},
  {empresa:"JR Sabater", municipio:"Murcia", sector:"Food and Beverage"},
  {empresa:"Betamadrileño", municipio:"Getafe", sector:"Nutrition and Pharma"},
  {empresa:"Laboratorios Maverick", municipio:"San Fernando de Henares", sector:"Perfume and Cosmetic"},
  {empresa:"Laboratorios Vinfer", municipio:"Albacete", sector:"Detergence and Chemistry"},
  {empresa:"Licores Sinc", municipio:"Alcoy", sector:"Food and Beverage"},
  {empresa:"Luis Caballero", municipio:"Cádiz", sector:"Food and Beverage"},
  {empresa:"Manuel Vieira", municipio:"Torres Novas", sector:"Detergence and Chemistry"},
  {empresa:"Marie Brizard", municipio:"Zizurkil", sector:"Food and Beverage"},
  {empresa:"Miguel Torres", municipio:"Vilafranca del Penedés", sector:"Food and Beverage"},
  {empresa:"Mixer and Pack", municipio:"Meco", sector:"Perfume and Cosmetic"},
  {empresa:"Aragonesa de Disolventes", municipio:"Zaragoza", sector:"Detergence and Chemistry"},
  {empresa:"Disolventes y Alcoholes del Ebro", municipio:"Zaragoza", sector:"Detergence and Chemistry"},
  {empresa:"Parque Logistico Carmona", municipio:"Carmona", sector:"Food and Beverage"},
  {empresa:"Pernod Ricard España", municipio:"Padrón", sector:"Food and Beverage"},
  {empresa:"Productos Capilares L´Oreal", municipio:"Villalonquejar", sector:"Perfume and Cosmetic"},
  {empresa:"Quimi Romar", municipio:"Naquera", sector:"Detergence and Chemistry"},
  {empresa:"Rives", municipio:"El Puerto de Santa Maria", sector:"Food and Beverage"},
  {empresa:"SAEQSA", municipio:"Alfajarin", sector:"Detergence and Chemistry"},
  {empresa:"Sanofi Aventis", municipio:"Riells i Viabrea", sector:"Nutrition and Pharma"},
  {empresa:"Stockmeier", municipio:"Sentmenat", sector:"Detergence and Chemistry"},
  {empresa:"Tecnoquimica Extremeña", municipio:"Guareña", sector:"Detergence and Chemistry"},
  {empresa:"Valenalcol", municipio:"Chiva", sector:"Detergence and Chemistry"},
  {empresa:"Vinagrerias Riojanas", municipio:"Logroño", sector:"Food and Beverage"},
  {empresa:"Vinagres Parras", municipio:"Torrijos", sector:"Food and Beverage"},
  {empresa:"Vittone 1842", municipio:"Vilamalla", sector:"Food and Beverage"},
  {empresa:"Zoco Pharmaceutical", municipio:"Dicastillo", sector:"Nutrition and Pharma"}
];

// ------------------ COORDENADAS APROXIMADAS ------------------
const MUNICIPIO_COORDS = {
  "Vedra": {lat:42.78, lon:-8.49},
  "Santa Margarida i Els Monjos": {lat:41.31, lon:1.65},
  "Córdoba": {lat:37.88, lon:-4.78},
  "Barcelona": {lat:41.39, lon:2.17},
  "Aldaia": {lat:39.46, lon:-0.46},
  "Marratxí": {lat:39.63, lon:2.76},
  "Mollet del Valles": {lat:41.54, lon:2.21},
  "Gélida": {lat:41.44, lon:1.86},
  "Valverde de Majano": {lat:40.96, lon:-4.24},
  "Tres Cantos": {lat:40.61, lon:-3.71},
  "Murcia": {lat:37.99, lon:-1.13},
  "Cheste": {lat:39.47, lon:-0.61},
  "Quart de Poblet": {lat:39.48, lon:-0.44},
  "Sant Joan de Les Fonts": {lat:42.20, lon:2.52},
  "La Jonquera": {lat:42.42, lon:2.87},
  "Jerez de la Frontera": {lat:36.69, lon:-6.14},
  "El Puerto de Santa Maria": {lat:36.60, lon:-6.23},
  "Fuenlabrada": {lat:40.28, lon:-3.80},
  "Montilla": {lat:37.58, lon:-4.64},
  "Almeria": {lat:36.83, lon:-2.46},
  "Anadia": {lat:40.44, lon:-8.44},
  "Ingenio": {lat:27.93, lon:-15.44},
  "Vale de Cambra": {lat:40.86, lon:-8.39},
  "Granollers": {lat:41.61, lon:2.29},
  "Antequera": {lat:37.02, lon:-4.56},
  "Cotimunde": {lat:42.87, lon:-8.55},
  "Almendralejo": {lat:38.69, lon:-6.40},
  "Atarfe": {lat:37.22, lon:-3.69},
  "Alcantarilla": {lat:37.97, lon:-1.22},
  "Cartagena": {lat:37.63, lon:-0.99},
  "Sartaguda": {lat:42.33, lon:-2.06},
  "Zuera": {lat:41.87, lon:-0.78},
  "Alcanena": {lat:39.46, lon:-8.67},
  "Molina de Segura": {lat:38.05, lon:-1.21},
  "Madrigueras": {lat:39.23, lon:-1.80},
  "Rute": {lat:37.33, lon:-4.37},
  "Toledo": {lat:39.86, lon:-4.02},
  "Valdemoro": {lat:40.19, lon:-3.68},
  "Lousa": {lat:40.12, lon:-8.25},
  "Getafe": {lat:40.30, lon:-3.73},
  "San Fernando de Henares": {lat:40.43, lon:-3.53},
  "Albacete": {lat:38.99, lon:-1.86},
  "Alcoy": {lat:38.70, lon:-0.47},
  "Cádiz": {lat:36.53, lon:-6.29},
  "Torres Novas": {lat:39.48, lon:-8.23},
  "Zizurkil": {lat:43.18, lon:-2.05},
  "Vilafranca del Penedés": {lat:41.35, lon:1.70},
  "Meco": {lat:40.55, lon:-3.30},
  "Zaragoza": {lat:41.65, lon:-0.88},
  "Carmona": {lat:37.47, lon:-5.64},
  "Padrón": {lat:42.74, lon:-8.66},
  "Villalonquejar": {lat:42.36, lon:-3.75},
  "Naquera": {lat:39.66, lon:-0.42},
  "Alfajarin": {lat:41.61, lon:-0.72},
  "Riells i Viabrea": {lat:41.78, lon:2.52},
  "Sentmenat": {lat:41.61, lon:2.08},
  "Guareña": {lat:38.86, lon:-6.10},
  "Chiva": {lat:39.47, lon:-0.71},
  "Logroño": {lat:42.47, lon:-2.45},
  "Torrijos": {lat:39.98, lon:-4.28},
  "Vilamalla": {lat:42.25, lon:2.96},
  "Dicastillo": {lat:42.60, lon:-1.94}
};

// ------------------ LÓGICA DEL MAPA ------------------
const map = L.map('map').setView([40, -4], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

const statusEl = document.getElementById('status');

// Colores por sector
const colorPorSector = (s) => ({
  "Perfume and Cosmetic":"#1f77b4",
  "Food and Beverage":"#d62728",
  "Detergence and Chemistry":"#2ca02c",
  "Nutrition and Pharma":"#9467bd"
}[s] || "#777");

// Agrupar clientes por municipio
const grupos = {};
CLIENTES.forEach(c => {
  const muni = c.municipio.trim();
  if (!MUNICIPIO_COORDS[muni]) {
    console.warn("Faltan coordenadas para municipio:", muni);
    return;
  }
  if (!grupos[muni]) grupos[muni] = [];
  grupos[muni].push(c);
});

// función para "separar" pines si hay varios en el mismo municipio
function jitterAround(lat, lon, index, total) {
  if (total === 1) return [lat, lon];
  const baseRadius = 0.08;   // grados (~5–8 km)
  const radius = baseRadius * (0.7 + total*0.07); // crece un poco con el nº de clientes
  const angle = (2 * Math.PI * index) / total;
  const dx = radius * Math.cos(angle);
  const dy = radius * Math.sin(angle);
  return [lat + dy, lon + dx];
}

let totalPines = 0;

Object.entries(grupos).forEach(([muni, lista]) => {
  const { lat, lon } = MUNICIPIO_COORDS[muni];
  lista.forEach((c, i) => {
    const [jLat, jLon] = jitterAround(lat, lon, i, lista.length);
    const color = colorPorSector(c.sector);
    const marker = L.circleMarker([jLat, jLon], {
      radius: 6,
      color,
      fillColor: color,
      fillOpacity: 0.9
    }).addTo(map);

    marker.bindPopup(
      `<b>${c.empresa}</b><br>` +
      `${c.municipio}<br>` +
      `<i>${c.sector}</i>`
    );

    totalPines++;
  });
});

// ------------------ ESTADÍSTICAS Y LEYENDA ------------------
const totalEmpresas = CLIENTES.length;

// conteo por sector
const conteo = {
  "Perfume and Cosmetic": 0,
  "Food and Beverage": 0,
  "Detergence and Chemistry": 0,
  "Nutrition and Pharma": 0
};

CLIENTES.forEach(c => {
  if (conteo[c.sector] !== undefined) {
    conteo[c.sector]++;
  }
});

const porcentajes = {};
Object.keys(conteo).forEach(k => {
  porcentajes[k] = ((conteo[k] / totalEmpresas) * 100).toFixed(1);
});

// actualizar texto de estado
statusEl.textContent =
  `Clientes colocados en el mapa: ${totalPines} de ${totalEmpresas} (en ${Object.keys(grupos).length} municipios).`;

// rellenar leyenda texto
const ordenSectores = [
  "Perfume and Cosmetic",
  "Food and Beverage",
  "Detergence and Chemistry",
  "Nutrition and Pharma"
];

const legendStatsEl = document.getElementById("legend-stats");
legendStatsEl.innerHTML = ordenSectores.map(s => `
  <div class="legend-item">
    <div class="legend-color" style="background:${colorPorSector(s)};"></div>
    ${s} — ${conteo[s]} empresas (${porcentajes[s]}%)
  </div>
`).join("");

// gráfico circular minimalista (pie chart CSS)
let start = 0;
const segments = [];
ordenSectores.forEach(s => {
  const val = parseFloat(porcentajes[s]); // porcentaje numérico
  const end = start + val;
  segments.push({color: colorPorSector(s), start, end});
  start = end;
});
const gradient = segments.map(seg =>
  `${seg.color} ${seg.start}% ${seg.end}%`
).join(", ");

const pieEl = document.getElementById("legend-pie");
pieEl.style.background = `conic-gradient(${gradient})`;

document.getElementById("legend-pie-caption").textContent =
  `Total: ${totalEmpresas} empresas`;
</script>

</body>
</html>
